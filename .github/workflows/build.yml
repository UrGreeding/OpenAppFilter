name: Build OpenAppFilter native ARM64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  native-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential make git ncurses-dev libssl-dev \
            wget unzip python3 python3-setuptools rsync

      - name: Download and extract OpenWrt SDK
        run: |
          # 下载 SDK
          SDK_URL="https://downloads.openwrt.org/releases/22.03.5/targets/armvirt/64/openwrt-sdk-22.03.5-armvirt-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
          wget $SDK_URL
          
          # 解压
          tar -xf openwrt-sdk-*.tar.xz
          
          # 获取解压后的目录名
          SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk*" | head -1)
          echo "SDK directory: $SDK_DIR"
          
          # 重命名为固定名称以便后续步骤使用
          mv "$SDK_DIR" openwrt-sdk

      - name: Add OpenAppFilter to SDK
        run: |
          cd openwrt-sdk
          git clone https://github.com/destan19/OpenAppFilter.git package/openappfilter
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure and build
        run: |
          cd openwrt-sdk
          echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config
          echo "CONFIG_PACKAGE_oaf=y" >> .config
          echo "CONFIG_PACKAGE_open-app-filter=y" >> .config
          make defconfig
          make package/openappfilter/compile V=s -j$(nproc)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openappfilter-native-arm64
          path: openwrt-sdk/bin/packages/*/base/*oaf*.ipk
