name: Build OpenAppFilter native ARM64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  native-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential make git ncurses-dev libssl-dev \
            wget unzip python3 python3-setuptools rsync

      - name: Download and setup OpenWrt SDK
        run: |
          # 下载 SDK
          SDK_URL="https://downloads.openwrt.org/releases/22.03.5/targets/armvirt/64/openwrt-sdk-22.03.5-armvirt-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
          wget $SDK_URL
          
          # 直接解压到当前目录（会自动创建正确的子目录）
          tar -xf openwrt-sdk-*.tar.xz
          
          # 进入解压后的目录（通常以 openwrt-sdk10 开头）
          cd openwrt-sdk-*

      - name: Add and build OpenAppFilter
        run: |
          # 克隆 OpenAppFilter
          git clone https://github.com/destan19/OpenAppFilter.git package/openappfilter
          
          # 更新 feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # 配置并编译
          echo "CONFIG_PACKAGE_luci-app-oaf=y" >> .config
          echo "CONFIG_PACKAGE_oaf=y" >> .config
          make defconfig
          make package/openappfilter/compile V=s -j$(nproc)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openappfilter-native-arm64
          path: openwrt-sdk-*/bin/packages/*/base/*oaf*.ipk
